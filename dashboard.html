<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasure Hunt - Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="[https://fonts.googleapis.com](https://fonts.googleapis.com)">
    <link rel="preconnect" href="[https://fonts.gstatic.com](https://fonts.gstatic.com)" crossorigin>
    <link href="[https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap](https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap)" rel="stylesheet">
    <!-- SUPABASE-JS CDN -->
    <script src="[https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2](https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2)"></script>
</head>
<body>
    <header class="app-header">
        <div class="header-content">
            <h2>Treasure Hunt</h2>
            <div class="user-info">
                <span id="usernameDisplay"></span> | Score: <span id="scoreDisplay">0</span>
            </div>
            <button id="logoutButton" class="btn-secondary">Logout</button>
        </div>
    </header>

    <div class="container">
        <div id="loadingState" class="game-card">
            <p>Loading your adventure...</p>
        </div>
        
        <div id="gameState" class="game-card" style="display: none;">
            <div class="checkpoint-header">
                <h3>Checkpoint <span id="checkpointNumber"></span></h3>
                <p id="checkpointPuzzle" class="puzzle-text"></p>
            </div>
            
            <div class="checkpoint-actions">
                <div class="input-group">
                    <label for="secretCodeInput">Enter Secret Code</label>
                    <input type="text" id="secretCodeInput" placeholder="Found a code? Enter it here...">
                </div>
                <button id="submitCodeButton" class="btn-primary">Submit Code</button>
            </div>

            <div class="support-actions">
                <button id="hintButton" class="btn-secondary">Get a Hint</button>
                <button id="skipButton" class="btn-danger">Skip Checkpoint</button>
            </div>
        </div>

        <div id="finishedState" class="game-card" style="display: none;">
            <h2>Congratulations!</h2>
            <p>You have completed the treasure hunt!</p>
            <p>Your final score is <strong id="finalScore"></strong>.</p>
        </div>
    </div>

    <!-- Modal for hints and messages -->
    <div id="modal" class="modal-overlay" style="display:none;">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasure Hunt - Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <header class="app-header">
        <div class="header-content">
            <h2>Treasure Hunt</h2>
            <div class="user-info">
                <span id="usernameDisplay"></span> | Score: <span id="scoreDisplay">0</span>
            </div>
            <button id="logoutButton" class="btn-secondary">Logout</button>
        </div>
    </header>
    <div class="container">
        <div id="loadingState" class="game-card">
            <p>Loading your adventure...</p>
        </div>
        <div id="gameState" class="game-card" style="display: none;">
            <div class="checkpoint-header">
                <h3>Checkpoint <span id="checkpointNumber"></span></h3>
                <p id="checkpointPuzzle" class="puzzle-text"></p>
            </div>
            <div class="checkpoint-actions">
                <div class="input-group">
                    <label for="secretCodeInput">Enter Secret Code</label>
                    <input type="text" id="secretCodeInput" placeholder="Found a code? Enter it here...">
                </div>
                <button id="submitCodeButton" class="btn-primary">Submit Code</button>
            </div>
            <div class="support-actions">
                <button id="hintButton" class="btn-secondary">Get a Hint</button>
                <button id="skipButton" class="btn-danger">Skip Checkpoint</button>
            </div>
        </div>
        <div id="finishedState" class="game-card" style="display: none;">
            <h2>Congratulations!</h2>
            <p>You have completed the treasure hunt!</p>
            <p>Your final score is <strong id="finalScore"></strong>.</p>
        </div>
    </div>
    <div id="modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <button id="modalCloseButton" class="btn-primary">Close</button>
        </div>
    </div>
    <script>
        // --- SUPABASE CLIENT SETUP ---
        const SUPABASE_URL = 'https://sfvnssyrmikyyyewwdkw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmdm5zc3lybWlreXl5ZXd3ZGt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxNjI3NjksImV4cCI6MjA2OTczODc2OX0.SqPgb7f_iU7uVj1IW5AVJWo2qHsPLPXMiXMy9g88JgQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM ELEMENTS ---
        const loadingState = document.getElementById('loadingState');
        const gameState = document.getElementById('gameState');
        const finishedState = document.getElementById('finishedState');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const checkpointNumber = document.getElementById('checkpointNumber');
        const checkpointPuzzle = document.getElementById('checkpointPuzzle');
        const secretCodeInput = document.getElementById('secretCodeInput');
        const submitCodeButton = document.getElementById('submitCodeButton');
        const hintButton = document.getElementById('hintButton');
        const skipButton = document.getElementById('skipButton');
        const finalScore = document.getElementById('finalScore');
        const logoutButton = document.getElementById('logoutButton');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseButton = document.getElementById('modalCloseButton');

        // --- GLOBAL STATE ---
        let currentUser = null;
        let userProfile = null;
        let currentCheckpoint = null;
        const TOTAL_CHECKPOINTS = 4;

        // --- MODAL CONTROLS ---

        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.style.display = 'flex';
            // Focus the close button for accessibility
            setTimeout(() => { modalCloseButton.focus(); }, 100);
        }

        // Close modal on button click
        modalCloseButton.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // Close modal on ESC key
        document.addEventListener('keydown', (e) => {
            if (modal.style.display === 'flex' && (e.key === 'Escape' || e.key === 'Esc')) {
                modal.style.display = 'none';
            }
        });

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Get current user session
            const { data: { session }, error } = await supabase.auth.getSession();
            if (error || !session) {
                // No user logged in, redirect to login page
                window.location.href = 'index.html';
                return;
            }
            currentUser = session.user;
            // 2. Fetch user profile and initialize the game
            await fetchUserProfileAndInit();
        });

        async function fetchUserProfileAndInit() {
            // Fetch profile data (username, score)
            const { data, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();
            if (error) {
                showModal('Error', 'Could not load your profile. Please try logging in again.');
                return;
            }
            userProfile = data;
            usernameDisplay.textContent = userProfile.username;
            scoreDisplay.textContent = userProfile.total_score;
            // Check if user has progress records, if not, create them
            await initializeUserProgress();
            // Fetch current game state
            await fetchCurrentGameState();
        }

        async function initializeUserProgress() {
            const { data, error } = await supabase
                .from('progress')
                .select('id')
                .eq('user_id', currentUser.id);
            // If no progress records exist, create them for all checkpoints
            if (data && data.length === 0) {
                const progressRecords = [];
                for (let i = 1; i <= TOTAL_CHECKPOINTS; i++) {
                    progressRecords.push({
                        user_id: currentUser.id,
                        checkpoint_id: i,
                        status: i === 1 ? 'unlocked' : 'locked'
                    });
                }
                await supabase.from('progress').insert(progressRecords);
            }
        }

        // --- GAME LOGIC ---
        async function fetchCurrentGameState() {
            // Find the first 'unlocked' checkpoint for the user
            const { data, error } = await supabase
                .from('progress')
                .select(`*, checkpoints ( * )`)
                .eq('user_id', currentUser.id)
                .eq('status', 'unlocked')
                .order('checkpoint_id', { ascending: true })
                .limit(1)
                .single();
            loadingState.style.display = 'none';
            if (error || !data) {
                // No unlocked checkpoints found, user must have finished
                gameState.style.display = 'none';
                finishedState.style.display = 'block';
                finalScore.textContent = userProfile.total_score;
            } else {
                // Display the current checkpoint
                currentCheckpoint = data;
                gameState.style.display = 'block';
                finishedState.style.display = 'none';
                checkpointNumber.textContent = currentCheckpoint.checkpoint_id;
                checkpointPuzzle.textContent = currentCheckpoint.checkpoints.puzzle;
            }
        }

        // --- EVENT HANDLERS ---
        submitCodeButton.addEventListener('click', async () => {
            const enteredCode = secretCodeInput.value.trim().toUpperCase();
            if (!enteredCode) {
                showModal('Invalid Input', 'Please enter a code.');
                return;
            }
            if (enteredCode === currentCheckpoint.checkpoints.secret_code.toUpperCase()) {
                // Correct code!
                const pointsEarned = currentCheckpoint.checkpoints.base_points;
                userProfile.total_score += pointsEarned;
                // Update progress table for current checkpoint
                await supabase
                    .from('progress')
                    .update({ status: 'completed', score: pointsEarned, completed_at: new Date().toISOString() })
                    .eq('user_id', currentUser.id)
                    .eq('checkpoint_id', currentCheckpoint.checkpoint_id);
                // Update total score in profiles table
                await supabase
                    .from('profiles')
                    .update({ total_score: userProfile.total_score })
                    .eq('id', currentUser.id);
                // Unlock the next checkpoint if it exists
                const nextCheckpointId = currentCheckpoint.checkpoint_id + 1;
                if (nextCheckpointId <= TOTAL_CHECKPOINTS) {
                    await supabase
                        .from('progress')
                        .update({ status: 'unlocked' })
                        .eq('user_id', currentUser.id)
                        .eq('checkpoint_id', nextCheckpointId);
                }
                showModal('Success!', `Correct! You earned ${pointsEarned} points.`);
                secretCodeInput.value = '';
                scoreDisplay.textContent = userProfile.total_score;
                await fetchCurrentGameState(); // Refresh the view
            } else {
                // Incorrect code
                showModal('Incorrect', 'That code is not correct. Please try again.');
                secretCodeInput.value = '';
            }
        });

        hintButton.addEventListener('click', async () => {
            const penalty = currentCheckpoint.checkpoints.hint_penalty;
            const newScore = Math.max(0, userProfile.total_score - penalty);
            // Update score in DB first
            await supabase
                .from('profiles')
                .update({ total_score: newScore })
                .eq('id', currentUser.id);
            // Update hint_used status
            await supabase
                .from('progress')
                .update({ hint_used: true })
                .eq('user_id', currentUser.id)
                .eq('checkpoint_id', currentCheckpoint.checkpoint_id);
            // Update local state and UI
            userProfile.total_score = newScore;
            scoreDisplay.textContent = newScore;
            showModal('Hint', `Here is a hint (penalty: ${penalty} points): ${currentCheckpoint.checkpoints.hint}`);
        });

        skipButton.addEventListener('click', async () => {
            const penalty = currentCheckpoint.checkpoints.skip_penalty;
            const newScore = Math.max(0, userProfile.total_score - penalty);
            // Update score
            await supabase
                .from('profiles')
                .update({ total_score: newScore })
                .eq('id', currentUser.id);
            // Mark current checkpoint as completed (with 0 score for this one)
            await supabase
                .from('progress')
                .update({ status: 'completed', score: 0, completed_at: new Date().toISOString() })
                .eq('user_id', currentUser.id)
                .eq('checkpoint_id', currentCheckpoint.checkpoint_id);
            // Unlock next checkpoint
            const nextCheckpointId = currentCheckpoint.checkpoint_id + 1;
            if (nextCheckpointId <= TOTAL_CHECKPOINTS) {
                await supabase
                    .from('progress')
                    .update({ status: 'unlocked' })
                    .eq('user_id', currentUser.id)
                    .eq('checkpoint_id', nextCheckpointId);
            }
            // Update local state and UI
            userProfile.total_score = newScore;
            scoreDisplay.textContent = newScore;
            showModal('Checkpoint Skipped', `You skipped the checkpoint. Penalty: ${penalty} points.`);
            await fetchCurrentGameState(); // Refresh the view
        });

        // --- LOGOUT HANDLER ---
        logoutButton.addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        });
    
        async function fetchUserProfileAndInit() {
            // Fetch profile data (username, score)
            const { data, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();
            
            if (error) {
                showModal('Error', 'Could not load your profile. Please try logging in again.');
                return;
            }
            userProfile = data;
            usernameDisplay.textContent = userProfile.username;
            scoreDisplay.textContent = userProfile.total_score;

            // Check if user has progress records, if not, create them
            await initializeUserProgress();
            
            // Fetch current game state
            await fetchCurrentGameState();
        }
        
        async function initializeUserProgress() {
            const { data, error } = await supabase
                .from('progress')
                .select('id')
                .eq('user_id', currentUser.id);

            // If no progress records exist, create them for all checkpoints
            if (data && data.length === 0) {
                const progressRecords = [];
                for (let i = 1; i <= TOTAL_CHECKPOINTS; i++) {
                    progressRecords.push({
                        user_id: currentUser.id,
                        checkpoint_id: i,
                        // Unlock the first checkpoint
                        status: i === 1 ? 'unlocked' : 'locked'
                    });
                }
                await supabase.from('progress').insert(progressRecords);
            }
        }

        // --- GAME LOGIC ---
        async function fetchCurrentGameState() {
            // Find the first 'unlocked' checkpoint for the user
            const { data, error } = await supabase
                .from('progress')
                .select(`
                    *,
                    checkpoints ( * )
                `)
                .eq('user_id', currentUser.id)
                .eq('status', 'unlocked')
                .order('checkpoint_id', { ascending: true })
                .limit(1)
                .single();
            
            loadingState.style.display = 'none';

            if (error || !data) {
                // No unlocked checkpoints found, user must have finished
                gameState.style.display = 'none';
                finishedState.style.display = 'block';
                finalScore.textContent = userProfile.total_score;
            } else {
                // Display the current checkpoint
                currentCheckpoint = data;
                gameState.style.display = 'block';
                finishedState.style.display = 'none';
                checkpointNumber.textContent = currentCheckpoint.checkpoint_id;
                checkpointPuzzle.textContent = currentCheckpoint.checkpoints.puzzle;
            }
        }

        // --- EVENT HANDLERS ---
        submitCodeButton.addEventListener('click', async () => {
            const enteredCode = secretCodeInput.value.trim().toUpperCase();
            if (!enteredCode) {
                showModal('Invalid Input', 'Please enter a code.');
                return;
            }

            if (enteredCode === currentCheckpoint.checkpoints.secret_code.toUpperCase()) {
                // Correct code!
                const pointsEarned = currentCheckpoint.checkpoints.base_points;
                userProfile.total_score += pointsEarned;
                
                // Update progress table for current checkpoint
                await supabase
                    .from('progress')
                    .update({ status: 'completed', score: pointsEarned, completed_at: new Date().toISOString() })
                    .eq('user_id', currentUser.id)
                    .eq('checkpoint_id', currentCheckpoint.checkpoint_id);
                
                // Update total score in profiles table
                await supabase
                    .from('profiles')
                    .update({ total_score: userProfile.total_score })
                    .eq('id', currentUser.id);

                // Unlock the next checkpoint if it exists
                const nextCheckpointId = currentCheckpoint.checkpoint_id + 1;
                if (nextCheckpointId <= TOTAL_CHECKPOINTS) {
                    await supabase
                        .from('progress')
                        .update({ status: 'unlocked' })
                        .eq('user_id', currentUser.id)
                        .eq('checkpoint_id', nextCheckpointId);
                }
                
                showModal('Success!', `Correct! You earned ${pointsEarned} points.`);
                secretCodeInput.value = '';
                scoreDisplay.textContent = userProfile.total_score;
                await fetchCurrentGameState(); // Refresh the view
            } else {
                // Incorrect code
                showModal('Incorrect', 'That code is not correct. Please try again.');
                secretCodeInput.value = '';
            }
        });

        hintButton.addEventListener('click', async () => {
            const penalty = currentCheckpoint.checkpoints.hint_penalty;
            const newScore = Math.max(0, userProfile.total_score - penalty);

            // Update score in DB first
            await supabase
                .from('profiles')
                .update({ total_score: newScore })
                .eq('id', currentUser.id);
            
            // Update hint_used status
            await supabase
                .from('progress')
                .update({ hint_used: true })
                .eq('user_id', currentUser.id)
                .eq('checkpoint_id', currentCheckpoint.checkpoint_id);

            // Update local state and UI
            userProfile.total_score = newScore;
            scoreDisplay.textContent = newScore;
            
            showModal('Hint', `Here is a hint (penalty: ${penalty} points): ${currentCheckpoint.checkpoints.hint}`);
        });

        skipButton.addEventListener('click', async () => {
            const penalty = currentCheckpoint.checkpoints.skip_penalty;
            const newScore = Math.max(0, userProfile.total_score - penalty);
            
            // Update score
            await supabase
                .from('profiles')
                .update({ total_score: newScore })
                .eq('id', currentUser.id);

            // Mark current checkpoint as completed (with 0 score for this one)
            await supabase
                .from('progress')
                .update({ status: 'completed', score: 0, completed_at: new Date().toISOString() })
                .eq('user_id', currentUser.id)
                .eq('checkpoint_id', currentCheckpoint.checkpoint_id);
            
            // Unlock next checkpoint
            const nextCheckpointId = currentCheckpoint.checkpoint_id + 1;
            if (nextCheckpointId <= TOTAL_CHECKPOINTS) {
                await supabase
                    .from('progress')
                    .update({ status: 'unlocked' })
                    .eq('user_id', currentUser.id)
                    .eq('checkpoint_id', nextCheckpointId);
            }
            
            // Update local state and UI
            userProfile.total_score = newScore;
            scoreDisplay.textContent = newScore;

            showModal('Checkpoint Skipped', `You skipped the checkpoint. Penalty: ${penalty} points.`);
            await fetchCurrentGameState(); // Refresh the view
        });

        // Attach logout handler after DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', async () => {
                    console.log('Logout button clicked! (from dashboard.html)');
                    alert('Logout button was pressed!');
                    // Comment out actual signOut for troubleshooting
                    // try {
                    //     const { error } = await supabase.auth.signOut();
                    //     if (error) {
                    //         console.error('Logout error:', error.message);
                    //     } else {
                    //         console.log('Logout successful, redirecting...');
                    //         window.location.href = 'index.html';
                    //     }
                    // } catch (e) {
                    //     console.error('Logout exception:', e);
                    // }
                });
            } else {
                console.log('Logout button not found on this page.');
            }
        });
    </script>
</body>
</html>