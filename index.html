<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasure Hunt - Login</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- SUPABASE-JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <div class="auth-card">
<!DOCTYPE html>
<!-- <html lang="en"> -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasure Hunt - Login</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- SUPABASE-JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>Treasure Hunt</h1>
                <p>Login or create an account to begin</p>
            </div>
            <div class="auth-tabs">
                <button id="loginTab" class="tab active" type="button">Login</button>
                <button id="signupTab" class="tab" type="button">Sign Up</button>
            </div>
            <!-- Login Form -->
            <form id="loginForm" class="auth-form active">
                <div class="input-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required autocomplete="username">
                </div>
                <div class="input-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn-primary">Login</button>
            </form>
            <!-- Sign-Up Form -->
            <form id="signupForm" class="auth-form">
                <div class="input-group">
                    <label for="signupUsername">Username</label>
                    <input type="text" id="signupUsername" required>
                </div>
                <div class="input-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" required autocomplete="username">
                </div>
                <div class="input-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" required autocomplete="new-password">
                </div>
                <button type="submit" class="btn-primary">Create Account</button>
            </form>
            <p id="errorMessage" class="error-message"></p>
        </div>
    </div>
</body>
    <script>
        // --- SUPABASE CLIENT SETUP ---
        const SUPABASE_URL = 'https://sfvnssyrmikyyyewwdkw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmdm5zc3lybWlreXl5ZXd3ZGt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxNjI3NjksImV4cCI6MjA2OTczODc2OX0.SqPgb7f_iU7uVj1IW5AVJWo2qHsPLPXMiXMy9g88JgQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM ELEMENTS ---
        const loginTab = document.getElementById('loginTab');
        const signupTab = document.getElementById('signupTab');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const errorMessage = document.getElementById('errorMessage');

        // --- TAB SWITCHING ---
        loginTab.addEventListener('click', () => {
            loginTab.classList.add('active');
            signupTab.classList.remove('active');
            loginForm.classList.add('active');
            signupForm.classList.remove('active');
            errorMessage.textContent = '';
        });
        signupTab.addEventListener('click', () => {
            loginTab.classList.remove('active');
            signupTab.classList.add('active');
            loginForm.classList.remove('active');
            signupForm.classList.add('active');
            errorMessage.textContent = '';
        });

        // --- SIGN-UP HANDLER ---
        signupForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            errorMessage.textContent = '';
            // 1. Create the user in Supabase Auth
            const { data: { user }, error } = await supabase.auth.signUp({
                email,
                password,
                options: { data: { username } }
            });
            if (error) {
                errorMessage.textContent = `Sign-up failed: ${error.message}`;
                return;
            }
            if (user) {
                // 2. Create the corresponding profile in the `profiles` table
                const { error: profileError } = await supabase
                    .from('profiles')
                    .insert({ id: user.id, username });
                if (profileError) {
                    errorMessage.textContent = `Profile creation failed: ${profileError.message}`;
                    return;
                }
                // 3. Automatically log the user in and redirect
                await handleLogin(email, password);
            }
        });

        // --- LOGIN HANDLER ---
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            errorMessage.textContent = '';
            await handleLogin(email, password);
        });

        async function handleLogin(email, password) {
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                errorMessage.textContent = `Login failed: ${error.message}`;
                return;
            }
            if (data.user) {
                // Check user role and redirect
                await checkUserRoleAndRedirect(data.user.id);
            }
        }

        // --- REDIRECTION LOGIC ---
        async function checkUserRoleAndRedirect(userId) {
            const { data, error } = await supabase
                .from('profiles')
                .select('role')
                .eq('id', userId)
                .single();
            if (error) {
                errorMessage.textContent = `Could not find user profile: ${error.message}`;
                return;
            }
            if (data.role === 'admin') {
                window.location.href = 'admin.html';
            } else {
                window.location.href = 'dashboard.html';
            }
        }
    
        function switchTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const signupTab = document.getElementById('signupTab');
            
            if (tab === 'login') {
                loginForm.classList.add('active');
                signupForm.classList.remove('active');
                loginTab.classList.add('active');
                signupTab.classList.remove('active');
            } else {
                loginForm.classList.remove('active');
                signupForm.classList.add('active');
                loginTab.classList.remove('active');
                signupTab.classList.add('active');
            }
            errorMessage.textContent = '';
        }

        // --- AUTHENTICATION HANDLERS ---

        // Handle Sign-Up
        signupForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const username = document.getElementById('signupUsername').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            // 1. Create the user in Supabase Auth
            const { data: { user }, error } = await supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: {
                        username: username,
                    }
                }
            });

            if (error) {
                errorMessage.textContent = `Sign-up failed: ${error.message}`;
                return;
            }
            
            if (user) {
                // 2. Create the corresponding profile in the `profiles` table
                const { error: profileError } = await supabase
                    .from('profiles')
                    .insert({ id: user.id, username: username });

                if (profileError) {
                     errorMessage.textContent = `Profile creation failed: ${profileError.message}`;
                     return;
                }
                
                // 3. Automatically log the user in and redirect
                await handleLogin(email, password);
            }
        });

        // Handle Login
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            await handleLogin(email, password);
        });
        
        async function handleLogin(email, password) {
             const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                errorMessage.textContent = `Login failed: ${error.message}`;
                return;
            }

            if (data.user) {
                // Check user role and redirect
                await checkUserRoleAndRedirect(data.user.id);
            }
        }

        // --- REDIRECTION LOGIC ---
        async function checkUserRoleAndRedirect(userId) {
            const { data, error } = await supabase
                .from('profiles')
                .select('role')
                .eq('id', userId)
                .single();

            if (error) {
                errorMessage.textContent = `Could not find user profile: ${error.message}`;
                return;
            }

            if (data.role === 'admin') {
                window.location.href = 'admin.html';
            } else {
                window.location.href = 'dashboard.html';
            }
        }
        

        // Add logout button handler for troubleshooting
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                await checkUserRoleAndRedirect(session.user.id);
            }

            // Attach logout handler if button exists
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', async () => {
                    console.log('Logout button clicked! (from index.html)');
                    alert('Logout button was pressed!');
                    // Comment out actual signOut for troubleshooting
                    try {
                        const { error } = await supabase.auth.signOut();
                        if (error) {
                            console.error('Logout error:', error.message);
                        } else {
                            console.log('Logout successful, redirecting...');
                            window.location.href = 'index.html';
                        }
                    } catch (e) {
                        console.error('Logout exception:', e);
                    }
                });
            } else {
                console.log('Logout button not found on this page.');
            }
        });

    </script>
</html>